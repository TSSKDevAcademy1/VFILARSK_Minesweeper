package microunit;

import java.io.BufferedReader;
import java.io.FileReader;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;

public class TestRunner {
	
	public void processTestSuite(String filename) throws Exception{
		try(BufferedReader r = new BufferedReader(new FileReader(filename))) {
			String line;
			while((line = r.readLine()) != null){
				line = line.trim();
				if(!"".equals(line)){
				runTests(line);
				}
			}
		}
	}
	
	public void runTests(String className) throws Exception {
		Class<?> clazz;
		try {
			clazz = Class.forName(className);
		} catch (Exception e) {
			System.err.println("Not valid test class: " + className);
			return;
		}
		Object testCase;
		try {
			testCase = clazz.newInstance();
		} catch (Exception e) {
			System.err.println("Cannot create isntance for test class" + className);
			return;
		}

		for (Method method : clazz.getMethods()) {
			// TODO: over, ci metoda je v tvare public void XXX()
			if (method.isAnnotationPresent(Test.class)) {
				System.out.printf("Running test: %s.%s\n", clazz.getName(), method.getName());

				try {
					method.invoke(testCase);

					System.out.printf("Test successful: %s.%s\n", clazz.getName(), method.getName());
				} catch (InvocationTargetException e) {
					System.out.printf("Test failed: %s.%s\n", clazz.getName(), method.getName());
					e.getCause().printStackTrace();
				} catch (Exception e) {
					System.out.printf("Not valid test method: %s.%s\n", clazz.getName(), method.getName());
					e.printStackTrace();
				}

			}
		}
	}

	public static void main(String[] args) throws Exception {
		long time = 50;
		TestRunner runner = new TestRunner();
		runner.processTestSuite("tests");
		System.out.println((System.currentTimeMillis() - time)/1000);

	}

}
